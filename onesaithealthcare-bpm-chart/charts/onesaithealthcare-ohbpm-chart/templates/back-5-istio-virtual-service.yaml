{{- if eq .Values.global.domain.gateway_type "istio"  }}
kind: VirtualService
apiVersion: networking.istio.io/v1alpha3
metadata:
  name: {{ .Values.ohbpm.app.name }}-virtual-service
spec:
  gateways:
    - {{ .Values.ohbpm.app.gateway }}
  hosts:
    - '{{ .Values.ohbpm.app.host }}'
  http:
    - match:
        - uri:
            prefix: /ohbpm/assets/config
        - uri:
            prefix: /ohbpm/assets/css
      route:
        - destination:
            host: ohbpm-front
            port:
              number: 8080
    - match:
      - uri:
          prefix: /ohbpm/api
      - uri:
          prefix: /ohbpm/app
      - uri:
          prefix: /ohbpm/assets
      - uri:
          prefix: /ohbpm/lib
      headers:
        request:
          set:
            X-Forwarded-Host: {{ .Values.ohbpm.app.host }}
            X-Forwarded-Port: '{{ if eq .Values.global.domain.protocol "http" }}80{{ else if eq .Values.global.domain.protocol "https" }}443{{ end }}'
            X-Forwarded-Proto: {{ .Values.global.domain.protocol }}
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-back
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-smart/
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-smart-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-smart
      rewrite:
        uri: /ohbpm-smart/ 
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-smart-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-designer/
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-designer-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-designer
      rewrite:
        uri: /ohbpm-designer/ 
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-designer-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-prof/
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-prof-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-prof
      rewrite:
        uri: /ohbpm-prof/ 
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-prof-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm-webcomponents
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-webcomponents-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm/
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-front
            port:
              number: 8080
    - match:
        - uri:
            prefix: /ohbpm
      rewrite:
        uri: /ohbpm/ 
      route:
        - destination:
            host: {{ .Values.ohbpm.app.name }}-front
            port:
              number: 8080
{{- end }}
